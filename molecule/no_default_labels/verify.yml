---
- name: Validate Repo runners
  user: ansible
  hosts: all
  gather_facts: yes
  become: yes
  vars:
    runner_user: ansible
    github_repo: "{{ lookup('env', 'GITHUB_REPO') }}"
    github_account: "{{ lookup('env', 'GITHUB_ACCOUNT') }}"
    github_api_url: "https://api.github.com"
    access_token: "{{ lookup('env', 'PERSONAL_ACCESS_TOKEN') }}"
    runner_name: "{{ ansible_facts.hostname }}"

  tasks:
    - name: Check currently registered runners
      ansible.builtin.uri:
        url: "{{ github_api_url }}/repos/{{ github_owner | default(github_account) }}/{{ github_repo }}/actions/runners"
        headers:
          Authorization: "token {{ access_token }}"
          Accept: "application/vnd.github.v3+json"
        method: GET
        status_code: 200
        force_basic_auth: yes
      register: registered_runners

    - name: Check Runner
      ansible.builtin.assert:
        that:
          - registered_runners.json.runners.0.status == "online"
        quiet: true

    - debug:
        var: registered_runners.json.runners.0
        
    - name: Set fact - current labels
      ansible.builtin.set_fact:
        current_labels: "{{ registered_runners.json.runners.0 | json_query('labels[*].name') | list }}"

    - name: Check Labels (skipped if labels are OK)
      ansible.builtin.assert:
        that:
          - current_labels == ['testlabel1', 'testlabel2']
        fail_msg: "Expected only the custom labels 'testlabel1' and 'testlabel2', but got {{ current_labels }}"